<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWWLib Memory Optimization Test</title>
    <script src="wasm/jwwlib.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .stat-label {
            font-weight: bold;
            color: #333;
        }
        .memory-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .entity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .entity-stat {
            background: #fff;
            padding: 8px;
            border-radius: 3px;
            text-align: center;
        }
        .entity-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #1976d2;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        pre {
            background: #fff;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .performance-metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <h1>JWWLib Memory Optimization Test</h1>
    
    <div class="test-section">
        <input type="file" id="fileInput" accept=".jww" multiple>
        <button onclick="loadFiles()">Load JWW Files</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        let Module;
        let performanceResults = [];
        
        // Initialize the WASM module
        createJwwModule().then(module => {
            Module = module;
            console.log('WASM module loaded successfully');
        });

        function loadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                alert('Please select one or more JWW files');
                return;
            }

            performanceResults = [];
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Process files sequentially
            processFiles(files, 0);
        }

        async function processFiles(files, index) {
            if (index >= files.length) {
                showSummary();
                return;
            }

            const file = files[index];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                const result = await analyzeFile(file.name, new Uint8Array(arrayBuffer));
                performanceResults.push(result);
                
                // Process next file
                processFiles(files, index + 1);
            };
            
            reader.readAsArrayBuffer(file);
        }

        async function analyzeFile(fileName, data) {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'test-section';
            
            const startTime = performance.now();
            const initialMemory = Module.HEAP8.length;
            
            try {
                // Allocate memory for the file data
                const dataPtr = Module._malloc(data.length);
                Module.HEAPU8.set(data, dataPtr);

                // Create JWWReader instance
                const reader = new Module.JWWReader(dataPtr, data.length);
                
                const parseTime = performance.now() - startTime;
                
                // Get memory usage
                const memoryUsage = reader.getMemoryUsage();
                const finalMemory = Module.HEAP8.length;
                const memoryGrowth = finalMemory - initialMemory;
                
                // Get entity statistics
                const entityStats = reader.getEntityStats();
                
                // Get parsing errors
                const errors = reader.getParsingErrors();
                
                // Calculate entity count
                let totalEntities = 0;
                for (const key in entityStats) {
                    totalEntities += entityStats.get(key);
                }
                
                // Display results
                section.innerHTML = `
                    <h3>${fileName} (${(data.length / 1024).toFixed(2)} KB)</h3>
                    
                    <div class="memory-info">
                        <div class="stat-label">Memory Information</div>
                        <div class="performance-metric">
                            <span>Estimated Memory Usage:</span>
                            <span>${(memoryUsage / 1024 / 1024).toFixed(2)} MB</span>
                        </div>
                        <div class="performance-metric">
                            <span>WASM Heap Growth:</span>
                            <span>${(memoryGrowth / 1024 / 1024).toFixed(2)} MB</span>
                        </div>
                        <div class="performance-metric">
                            <span>Parse Time:</span>
                            <span>${parseTime.toFixed(2)} ms</span>
                        </div>
                        <div class="performance-metric">
                            <span>Total Entities:</span>
                            <span>${totalEntities}</span>
                        </div>
                        <div class="performance-metric">
                            <span>Memory per Entity:</span>
                            <span>${totalEntities > 0 ? (memoryUsage / totalEntities).toFixed(2) : 0} bytes</span>
                        </div>
                    </div>
                    
                    <div class="stat-label">Entity Statistics</div>
                    <div class="entity-stats">
                        ${Object.entries(entityStats).map(([type, count]) => `
                            <div class="entity-stat">
                                <div>${type}</div>
                                <div class="entity-count">${count}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${errors.size() > 0 ? `
                        <div class="stat-label error">Parsing Errors (${errors.size()})</div>
                        <pre>${JSON.stringify(errors, null, 2)}</pre>
                    ` : '<div class="success">No parsing errors</div>'}
                `;
                
                resultsDiv.appendChild(section);
                
                // Cleanup
                reader.delete();
                Module._free(dataPtr);
                
                return {
                    fileName,
                    fileSize: data.length,
                    parseTime,
                    memoryUsage,
                    memoryGrowth,
                    totalEntities,
                    errors: errors.size()
                };
                
            } catch (error) {
                section.innerHTML = `
                    <h3>${fileName}</h3>
                    <div class="error">Error: ${error.message}</div>
                `;
                resultsDiv.appendChild(section);
                
                return {
                    fileName,
                    fileSize: data.length,
                    error: error.message
                };
            }
        }

        function showSummary() {
            if (performanceResults.length === 0) return;
            
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'test-section';
            
            // Calculate summary statistics
            const validResults = performanceResults.filter(r => !r.error);
            if (validResults.length === 0) return;
            
            const avgParseTime = validResults.reduce((sum, r) => sum + r.parseTime, 0) / validResults.length;
            const totalMemory = validResults.reduce((sum, r) => sum + r.memoryUsage, 0);
            const totalEntities = validResults.reduce((sum, r) => sum + r.totalEntities, 0);
            const avgMemoryPerEntity = totalMemory / totalEntities;
            
            section.innerHTML = `
                <h3>Performance Summary</h3>
                <div class="memory-info">
                    <div class="performance-metric">
                        <span>Files Processed:</span>
                        <span>${validResults.length}</span>
                    </div>
                    <div class="performance-metric">
                        <span>Average Parse Time:</span>
                        <span>${avgParseTime.toFixed(2)} ms</span>
                    </div>
                    <div class="performance-metric">
                        <span>Total Memory Used:</span>
                        <span>${(totalMemory / 1024 / 1024).toFixed(2)} MB</span>
                    </div>
                    <div class="performance-metric">
                        <span>Total Entities:</span>
                        <span>${totalEntities}</span>
                    </div>
                    <div class="performance-metric">
                        <span>Average Memory per Entity:</span>
                        <span>${avgMemoryPerEntity.toFixed(2)} bytes</span>
                    </div>
                </div>
            `;
            
            resultsDiv.insertBefore(section, resultsDiv.firstChild);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            performanceResults = [];
        }

        // Monitor WASM memory usage
        setInterval(() => {
            if (Module && Module.HEAP8) {
                console.log('WASM Heap Size:', (Module.HEAP8.length / 1024 / 1024).toFixed(2), 'MB');
            }
        }, 5000);
    </script>
</body>
</html>